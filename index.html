<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
	<title>AI Asisten</title>
	<meta name="theme-color" content="#000000" />
	<link rel="manifest" href="manifest.json">
	<style>
		:root {
			--latar-utama: #000000;
			--latar-chat: #000000;
			--latar-header: #000000;
			--latar-input: #1c1c1e;
			--gelembung-ai: #1c1c1e;
			--gelembung-pengguna: rgba(10, 74, 153, 0.6);
			--teks-utama: #f5f5f7;
			--teks-putih: #ffffff;
			--teks-placeholder: #8e8e93;
			--border-color: #3a3a3c;
			--bayangan: 0 4px 12px rgba(0, 0, 0, 0.4);
			
			/* UKURAN RESPONSIVE TERPUSAT */
			--font-size-base: clamp(0.9rem, 2vw, 1rem);
			--font-size-sm: clamp(0.75rem, 1.5vw, 0.85rem);
			--font-size-xs: clamp(0.65rem, 1.2vw, 0.75rem);
			--icon-size: clamp(1.4rem, 4vw, 1.6rem);
		}
		
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		html,
		body {
			height: 100%;
			width: 100%;
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
			background-color: var(--latar-header);
			color: var(--teks-utama);
			overflow: hidden;
			font-size: var(--font-size-base);
		}
		
		/* HALAMAN LOGIN */
		#login-container {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100%;
			padding: 1rem;
		}
		
		.login-box {
			background-color: var(--latar-input);
			border: 1px solid var(--border-color);
			border-radius: 16px;
			padding: 2rem;
			width: 100%;
			max-width: 400px;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 1.5rem;
		}
		
		.login-icon svg {
			width: clamp(3rem, 10vw, 4rem);
			height: clamp(3rem, 10vw, 4rem);
		}
		
		.login-form {
			display: flex;
			flex-direction: column;
			gap: 1rem;
			width: 100%;
		}
		
		.login-input {
			background-color: #2c2c2e;
			border: 1px solid var(--border-color);
			border-radius: 12px;
			padding: 0.85rem 1rem;
			color: var(--teks-utama);
			width: 100%;
			font-size: 1rem;
			font-family: inherit;
		}
		
		.login-input:focus {
			outline: none;
			border-color: #007aff;
			box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
		}
		
		#login-button {
			background-image: linear-gradient(135deg, #005cbf, #007bff);
			color: white;
			border: none;
			border-radius: 12px;
			padding: 0.85rem 1rem;
			width: 100%;
			font-size: 1rem;
			font-weight: 600;
			cursor: pointer;
			transition: filter 0.2s ease;
			margin-top: 0.5rem;
		}
		
		#login-button:hover {
			filter: brightness(1.1);
		}
		
		/* PERBAIKAN UTAMA: STRUKTUR LAYOUT UNTUK HEADER & FOOTER TETAP */
		.chat-container {
			position: relative;
			display: flex;
			flex-direction: column;
			height: 100vh;
			max-height: -webkit-fill-available;
			background-color: var(--latar-chat);
			overflow: hidden;
		}
		
		/* HEADER - PERBAIKAN POSISI STICKY */
		header {
			position: sticky;
			top: 0;
			background-color: var(--latar-header);
			color: var(--teks-putih);
			padding: 0.5rem 1rem;
			flex-shrink: 0;
			z-index: 1000; /* Ditingkatkan untuk memastikan di atas konten */
			display: flex;
			align-items: center;
			width: 100%;
			max-width: 800px;
			margin: 0 auto;
			border-bottom: 1px solid var(--border-color); /* Garis pemisah */
		}
		
		.header-button {
			background: transparent;
			border: none;
			cursor: pointer;
			padding: 0.5rem;
			z-index: 1001;
			display: flex;
			align-items: center;
		}
		
		.header-button:hover svg {
			filter: brightness(1.2);
		}
		
		.header-button svg {
			width: var(--icon-size);
			height: var(--icon-size);
		}
		
		#new-chat-button {
			margin-left: -0.5rem;
			margin-right: auto;
		}
		
		#logout-button {
			margin-right: -0.5rem;
		}
		
		/* AREA CHAT - PERBAIKAN SCROLL */
		.chat-content-wrapper {
			flex: 1;
			width: 100%;
			max-width: 800px;
			margin: 0 auto;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
			/* Padding untuk mencegah konten tertutup header dan input */
			padding-top: 0.5rem;
			padding-bottom: 0.5rem;
		}
		
		.chat-window {
			padding: 0 1rem;
			display: flex;
			flex-direction: column;
			gap: 0.75rem;
			scrollbar-width: none;
		}
		
		.chat-window::-webkit-scrollbar {
			display: none;
		}
		
		/* PREVIEW FILE */
		#file-preview-container {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 0.5rem;
			padding-bottom: 0.5rem;
			width: 100%;
			max-width: 800px;
			margin: 0 auto;
			max-height: 160px;
			overflow-y: auto;
		}
		
		.preview-item {
			position: relative;
			display: flex;
			align-items: center;
			border: 1px solid var(--border-color);
			border-radius: 8px;
			background-color: var(--latar-input);
			padding: 0.5rem;
			min-height: 55px;
			overflow: hidden;
		}
		
		.preview-thumbnail,
		.preview-icon {
			flex-shrink: 0;
			width: clamp(1.8rem, 5vw, 2.2rem);
			height: clamp(1.8rem, 5vw, 2.2rem);
			object-fit: cover;
			border-radius: 4px;
		}
		
		.preview-details {
			flex-grow: 1;
			margin-left: 0.5rem;
			overflow: hidden;
		}
		
		.preview-name {
			font-size: var(--font-size-sm);
			color: var(--teks-utama);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			text-align: left;
		}
		
		.preview-size {
			display: block;
			font-size: var(--font-size-xs);
			color: var(--teks-placeholder);
			text-align: left;
		}
		
		.preview-remove {
			position: absolute;
			top: 5px;
			right: 5px;
			background-color: rgba(0, 0, 0, 0.6);
			border: none;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 20px;
			height: 20px;
			padding: 0;
		}
		
		.preview-remove svg {
			width: 12px;
			height: 12px;
		}
		
		.preview-item .loader {
			border: 4px solid #f3f3f3;
			border-top: 4px solid #3498db;
			border-radius: 50%;
			width: 30px;
			height: 30px;
			animation: spin 2s linear infinite;
		}
		
		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			
			100% {
				transform: rotate(360deg);
			}
		}
		
		/* INPUT AREA - PERBAIKAN POSISI STICKY */
		.input-area {
			position: sticky;
			bottom: 0;
			display: flex;
			flex-direction: column;
			padding: 0.75rem 1rem;
			background-color: var(--latar-header);
			flex-shrink: 0;
			z-index: 1000; /* Ditingkatkan untuk memastikan di atas konten */
			padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
			border-top: 1px solid var(--border-color); /* Garis pemisah */
		}
		
		/* STYLING PESAN */
		.message {
			max-width: 90%;
			padding: 0.75rem 1rem;
			border-radius: 18px;
			line-height: 1.5;
			word-wrap: break-word;
		}
		
		.message code {
			background-color: rgba(255, 255, 255, 0.1);
			padding: 0.2em 0.4em;
			border-radius: 3px;
			font-family: Consolas, 'Courier New', monospace;
		}
		
		.user-message {
			align-self: flex-end;
			background-color: var(--gelembung-pengguna);
			color: var(--teks-putih);
			border-bottom-right-radius: 4px;
		}
		
		.ai-message {
			align-self: flex-start;
			background-color: var(--gelembung-ai);
			color: var(--teks-utama);
			border-bottom-left-radius: 4px;
		}
		
		#typing-indicator {
			align-self: flex-start;
			padding: 0.75rem 1rem;
		}
		
		.typing-indicator {
			display: flex;
			align-items: center;
		}
		
		.typing-indicator span {
			height: 8px;
			width: 8px;
			margin: 0 2px;
			background-color: var(--teks-placeholder);
			border-radius: 50%;
			display: inline-block;
			animation: bounce 1.4s infinite ease-in-out both;
		}
		
		.typing-indicator span:nth-child(1) {
			animation-delay: -0.32s;
		}
		
		.typing-indicator span:nth-child(2) {
			animation-delay: -0.16s;
		}
		
		@keyframes bounce {

			0%,
			80%,
			100% {
				transform: scale(0);
			}
			
			40% {
				transform: scale(1.0);
			}
		}
		
		.input-wrapper {
			position: relative;
			display: flex;
			align-items: center;
			width: 100%;
			max-width: 800px;
			margin: 0 auto;
			background-color: var(--latar-input);
			border: 1px solid var(--border-color);
			border-radius: 22px;
			padding: 0 0.4rem;
			transition: border-color 0.2s ease;
		}
		
		.input-wrapper:focus-within {
			border-color: transparent;
			background-image:
				linear-gradient(var(--latar-input), var(--latar-input)),
				linear-gradient(135deg, #007aff, #00AFFF);
			background-origin: border-box;
			background-clip: padding-box, border-box;
		}
		
		.input-wrapper button {
			background: transparent;
			border: none;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 0.5rem;
			flex-shrink: 0;
		}
		
		.input-wrapper button svg {
			width: var(--icon-size);
			height: var(--icon-size);
			transition: filter 0.2s ease;
		}
		
		.input-wrapper button:disabled svg {
			filter: grayscale(100%);
			cursor: not-allowed;
		}
		
		#message-input {
			flex-grow: 1;
			background-color: transparent;
			color: var(--teks-utama);
			border: none;
			padding: 0.75rem 0.5rem;
			font-size: 1rem;
			font-family: inherit;
			resize: none;
			max-height: 180px;
			overflow-y: auto;
		}
		
		#message-input:focus {
			outline: none;
		}
		
		#send-button svg {
			transform: rotate(45deg) translate(1px, -1px);
			transition: all 0.2s ease;
		}
		
		.ai-message ol,
		.ai-message ul {
			padding-left: 1.5rem;
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.ai-message li {
			margin-bottom: 0.25rem;
		}
		
		.ai-message table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 1rem;
			margin-bottom: 1rem;
			font-size: 0.9rem;
		}
		
		.ai-message th,
		.ai-message td {
			border: 1px solid var(--border-color);
			padding: 0.5rem 0.75rem;
			text-align: left;
		}
		
		.ai-message th {
			background-color: rgba(255, 255, 255, 0.05);
			font-weight: 600;
		}
		
		.ai-message strong {
			font-weight: 600;
		}
		
		.ai-message em {
			font-style: italic;
		}
	</style>
</head>

<body>
	<svg width="0" height="0" style="position:absolute">
		<defs>
			<linearGradient id="icon-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
				<stop offset="0%" style="stop-color:#007aff;stop-opacity:1" />
				<stop offset="100%" style="stop-color:#00AFFF;stop-opacity:1" />
			</linearGradient>
		</defs>
	</svg>
	
	<div id="login-container">
		<div class="login-box">
			<div class="login-icon">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="url(#icon-gradient)">
					<path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
				</svg>
			</div>
			<div class="login-form">
				<input type="email" id="email-input" class="login-input" placeholder="Email (opsional)">
				<input type="password" id="password-input" class="login-input" placeholder="Password (opsional)">
				<button id="login-button">Login</button>
			</div>
		</div>
	</div>
	
	<div class="chat-container" style="display: none;">
		<header>
			<button id="new-chat-button" class="header-button" title="Percakapan Baru">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="url(#icon-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
					<path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z" />
				</svg>
			</button>
			<button id="logout-button" class="header-button" title="Logout">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="url(#icon-gradient)">
					<path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
				</svg>
			</button>
		</header>
		
		<div class="chat-content-wrapper">
			<div class="chat-window" id="chat-window">
			</div>
		</div>
		
		<div class="input-area">
			<div id="file-preview-container"></div>
			
			<div class="input-wrapper">
				<input type="file" id="file-input" multiple hidden accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.pdf,application/pdf,image/*">
				<button id="upload-button" title="Lampirkan File">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="url(#icon-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 8v8M8 12h8" />
					</svg>
				</button>
				<textarea id="message-input" placeholder="Ketik pesan Anda..." rows="1"></textarea>
				<button id="send-button" title="Kirim Pesan">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="url(#icon-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<line x1="22" y1="2" x2="11" y2="13"></line>
						<polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
					</svg>
				</button>
			</div>
		</div>
	</div>
	
	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const loginContainer = document.getElementById('login-container');
			const loginButton = document.getElementById('login-button');
			const chatContainer = document.querySelector('.chat-container');
			
			let apiKey = '';
			const chatWindow = document.getElementById('chat-window');
			const messageInput = document.getElementById('message-input');
			const sendButton = document.getElementById('send-button');
			const newChatButton = document.getElementById('new-chat-button');
			const uploadButton = document.getElementById('upload-button');
			const fileInput = document.getElementById('file-input');
			const filePreviewContainer = document.getElementById('file-preview-container');
			const logoutButton = document.getElementById('logout-button');
			
			let uploadedFiles = [];
			const MAX_FILES = 6;
			
			async function fetchWithRetry(url, options, maxRetries = 3) {
				for (let attempt = 1; attempt <= maxRetries; attempt++) {
					try {
						const response = await fetch(url, options);
						if (response.status >= 500 && response.status < 600) {
							throw new Error(`Server error with status ${response.status}`);
						}
						return response;
					} catch (error) {
						if (attempt === maxRetries) {
							console.error(`Fetch failed after ${maxRetries} attempts.`);
							throw error;
						}
						console.warn(`Attempt ${attempt} failed. Retrying in ${attempt}s...`);
						await new Promise(res => setTimeout(res, attempt * 1000));
					}
				}
			}
			
			async function getAIResponse(parts) {
				setChatInputDisabled(true);
				showTypingIndicator();
				let aiMessageElement = null;
				let fullResponseText = '';
				let characterQueue = [];
				let isStreamFinished = false;
				
				const renderSpeed = 10;
				
				function processQueue() {
					if (characterQueue.length > 0) {
						const charsToAdd = characterQueue.splice(0, 2).join('');
						fullResponseText += charsToAdd;
						if (aiMessageElement) {
							aiMessageElement.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
							chatWindow.scrollTop = chatWindow.scrollHeight;
						}
					}
					if (!isStreamFinished || characterQueue.length > 0) {
						setTimeout(processQueue, renderSpeed);
					}
				}
				
				const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:streamGenerateContent?alt=sse&key=${apiKey}`;
				const payload = {
					contents: [{ parts: parts }],
					tools: [{ "google_search": {} }],
					systemInstruction: {
						parts: [{
							text: "Anda adalah Nix AI Asisten yang profesional, handal, friendly dan suka membantu."
						}]
					},
					generationConfig: {
						temperature: 0.5,
						maxOutputTokens: 8192,
					}
				};
				
				try {
					const response = await fetchWithRetry(apiUrl, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					
					if (!response.ok) {
						const errorData = await response.json();
						throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
					}
					
					processQueue();
					
					const reader = response.body.getReader();
					const decoder = new TextDecoder();
					let isFirstChunk = true;
					
					while (true) {
						const { value, done } = await reader.read();
						if (done) {
							isStreamFinished = true;
							break;
						}
						
						const chunkText = decoder.decode(value);
						const lines = chunkText.split('\n');
						
						for (const line of lines) {
							if (line.startsWith('data: ')) {
								const jsonStr = line.substring(6);
								try {
									const chunkData = JSON.parse(jsonStr);
									const textPart = chunkData.candidates?.[0]?.content?.parts?.[0]?.text;
									if (textPart) {
										if (isFirstChunk) {
											removeTypingIndicator();
											aiMessageElement = document.createElement('div');
											aiMessageElement.classList.add('message', 'ai-message');
											chatWindow.appendChild(aiMessageElement);
											isFirstChunk = false;
										}
										characterQueue.push(...textPart.split(''));
									}
								} catch (e) {
									console.warn("Error parsing JSON chunk:", jsonStr, e);
								}
							}
						}
					}
					
					if (isFirstChunk) {
						addMessage("Maaf, saya tidak dapat memberikan jawaban saat ini.", 'ai');
					}
					
				} catch (error) {
					console.error('Error fetching AI response:', error);
					isStreamFinished = true;
					addMessage(`Maaf, terjadi masalah saat menghubungi layanan AI. Silakan coba lagi sesaat lagi.`, 'ai');
				} finally {
					removeTypingIndicator();
					setChatInputDisabled(false);
					messageInput.focus();
				}
			}
			
			function sendMessage() {
				const messageText = messageInput.value.trim();
				if (messageText === '' && uploadedFiles.length === 0) return;
				
				if (!apiKey) {
					apiKey = messageText;
					chatWindow.innerHTML = '';
					addSystemMessage('API Key berhasil disimpan. Gemini AI dengan Google Search sekarang aktif. Ada yang bisa saya bantu?', 'ai');
					messageInput.value = '';
					return;
				}
				
				let userPrompt = messageText;
				if (uploadedFiles.length > 0) {
					userPrompt += `\n\nLampiran: ${uploadedFiles.map(f => f.name).join(', ')}`;
				}
				addMessage(userPrompt, 'user');
				
				const parts = [];
				let combinedTextContent = messageText;
				
				uploadedFiles.forEach(file => {
					if (file.type === 'image') {
						parts.push({
							inlineData: {
								mimeType: file.mimeType,
								data: file.content.split(',')[1]
							}
						});
					} else {
						combinedTextContent += `\n\n--- Isi dari ${file.name} ---\n${file.content}`;
					}
				});
				
				parts.unshift({ text: combinedTextContent });
				
				getAIResponse(parts);
				
				messageInput.value = '';
				messageInput.style.height = 'auto';
				uploadedFiles = [];
				renderFilePreviews();
			}
			
			function startNewChat() {
				chatWindow.innerHTML = '';
				uploadedFiles = [];
				renderFilePreviews();
				if (!apiKey) {
					addSystemMessage('Halo! Saya adalah Nix AI Asisten. Untuk memulai, silakan masukkan Google AI API Key Anda lalu kirim.', 'ai');
				}
				messageInput.focus();
			}
			
			function handleFileSelect(event) {
				const files = event.target.files;
				if (!files) return;
				
				if (uploadedFiles.length + files.length > MAX_FILES) {
					alert(`Anda hanya dapat mengunggah maksimal ${MAX_FILES} file.`);
					return;
				}
				
				for (const file of files) {
					const fileData = {
						id: Date.now() + Math.random(),
						name: file.name,
						mimeType: file.type,
						content: null,
						type: null,
						size: file.size,
					};
					uploadedFiles.push(fileData);
					renderFilePreviews();
					
					processFile(file, fileData.id);
				}
				
				fileInput.value = '';
			}
			
			function processFile(file, fileId) {
				const reader = new FileReader();
				
				if (file.type.startsWith('image/')) {
					reader.readAsDataURL(file);
					reader.onload = () => {
						updateFileData(fileId, { content: reader.result, type: 'image' });
					};
				} else if (file.name.endsWith('.pdf')) {
					reader.readAsArrayBuffer(file);
					reader.onload = () => {
						extractPdfText(reader.result, fileId);
					};
				} else if (file.name.endsWith('.docx')) {
					reader.readAsArrayBuffer(file);
					reader.onload = () => {
						extractDocxText(reader.result, fileId);
					};
				} else if (file.name.endsWith('.xlsx')) {
					reader.readAsArrayBuffer(file);
					reader.onload = () => {
						extractXlsxText(reader.result, fileId);
					};
				} else {
					alert(`File tidak didukung: ${file.name}`);
					removeFile(fileId);
				}
				
				reader.onerror = () => {
					console.error("Gagal membaca file:", file.name);
					alert(`Gagal memproses file: ${file.name}`);
					removeFile(fileId);
				};
			}
			
			async function extractPdfText(arrayBuffer, fileId) {
				try {
					const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
					const pdf = await loadingTask.promise;
					const firstPage = await pdf.getPage(1);
					
					const viewport = firstPage.getViewport({ scale: 1.5 });
					const canvas = document.createElement('canvas');
					const context = canvas.getContext('2d');
					canvas.height = viewport.height;
					canvas.width = viewport.width;
					
					await firstPage.render({ canvasContext: context, viewport: viewport }).promise;
					const imageDataUrl = canvas.toDataURL('image/jpeg');
					
					updateFileData(fileId, { content: imageDataUrl, type: 'image', mimeType: 'image/jpeg' });
				} catch (error) {
					console.error("Error processing PDF as image:", error);
					alert("Gagal memproses file PDF sebagai gambar.");
					removeFile(fileId);
				}
			}
			
			async function extractDocxText(arrayBuffer, fileId) {
				try {
					const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
					updateFileData(fileId, { content: result.value, type: 'text' });
				} catch (error) {
					console.error("Error extracting DOCX text:", error);
					alert("Gagal mengekstrak teks dari Word.");
					removeFile(fileId);
				}
			}
			
			async function extractXlsxText(arrayBuffer, fileId) {
				try {
					const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
					let textContent = '';
					workbook.SheetNames.forEach(sheetName => {
						const worksheet = workbook.Sheets[sheetName];
						textContent += XLSX.utils.sheet_to_csv(worksheet);
					});
					updateFileData(fileId, { content: textContent, type: 'text' });
				} catch (error) {
					console.error("Error extracting XLSX text:", error);
					alert("Gagal mengekstrak teks dari Excel.");
					removeFile(fileId);
				}
			}
			
			function formatFileSize(bytes, decimals = 2) {
				if (bytes === 0) return '0 Bytes';
				const k = 1024;
				const dm = decimals < 0 ? 0 : decimals;
				const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
			}
			
			function getFileIconSvg(mimeType, fileName) {
				const addClass = (svg) => svg.replace('<svg ', '<svg class="preview-icon" ');
				
				if (mimeType.includes("pdf") || fileName.endsWith(".pdf")) return addClass(`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#EF4444" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#DC2626" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="7" font-family="sans-serif" font-weight="bold">PDF</text></svg>`);
				if (mimeType.includes("word") || fileName.endsWith(".docx")) return addClass(`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#3B82F6" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#2563EB" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="10" font-family="sans-serif" font-weight="bold">W</text></svg>`);
				if (mimeType.includes("sheet") || mimeType.includes("excel") || fileName.endsWith(".xlsx") || fileName.endsWith(".xls")) return addClass(`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#22C55E" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#16A3A" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="10" font-family="sans-serif" font-weight="bold">X</text></svg>`);
				return addClass(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" color="#8e8e93"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>`);
			}
			
			function updateFileData(fileId, data) {
				const fileIndex = uploadedFiles.findIndex(f => f.id === fileId);
				if (fileIndex !== -1) {
					Object.assign(uploadedFiles[fileIndex], data);
					renderFilePreviews();
				}
			}
			
			function removeFile(fileId) {
				uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
				renderFilePreviews();
			}
			
			function renderFilePreviews() {
				filePreviewContainer.innerHTML = '';
				if (uploadedFiles.length === 0) {
					filePreviewContainer.style.paddingBottom = '0';
					return;
				}
				filePreviewContainer.style.paddingBottom = '0.5rem';
				
				uploadedFiles.forEach(file => {
					const item = document.createElement('div');
					item.className = 'preview-item';
					
					if (!file.content) {
						item.style.justifyContent = 'center';
						item.innerHTML = '<div class="loader"></div>';
					} else {
						let thumbnailHtml = '';
						if (file.name.endsWith('.pdf')) {
							thumbnailHtml = getFileIconSvg(file.mimeType, file.name);
						} else if (file.type === 'image') {
							thumbnailHtml = `<img src="${file.content}" class="preview-thumbnail" alt="Pratinjau">`;
						} else {
							thumbnailHtml = getFileIconSvg(file.mimeType, file.name);
						}
						
						const removeIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" fill="url(#icon-gradient)" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`;
						
						item.innerHTML = `
							<button class="preview-remove">${removeIconSvg}</button>
							${thumbnailHtml}
							<div class="preview-details">
								<div class="preview-name" title="${file.name}">${file.name}</div>
								<div class="preview-size">${formatFileSize(file.size)}</div>
							</div>
						`;
						item.querySelector('.preview-remove').onclick = () => removeFile(file.id);
					}
					filePreviewContainer.appendChild(item);
				});
			}
			
			function addMessage(text, sender) {
				const messageElement = document.createElement('div');
				messageElement.classList.add('message', `${sender}-message`);
				
				if (sender === 'ai') {
					const rawHtml = marked.parse(text);
					messageElement.innerHTML = DOMPurify.sanitize(rawHtml);
				} else {
					messageElement.textContent = text;
				}
				
				chatWindow.appendChild(messageElement);
				chatWindow.scrollTop = chatWindow.scrollHeight;
			}
			
			function addSystemMessage(html, sender) {
				const messageElement = document.createElement('div');
				messageElement.classList.add('message', `${sender}-message`);
				messageElement.innerHTML = html;
				chatWindow.appendChild(messageElement);
				chatWindow.scrollTop = chatWindow.scrollHeight;
			}
			
			function showTypingIndicator() {
				if (document.getElementById('typing-indicator')) return;
				const indicatorWrapper = document.createElement('div');
				indicatorWrapper.id = 'typing-indicator';
				
				const indicator = document.createElement('div');
				indicator.classList.add('typing-indicator');
				indicator.innerHTML = '<span></span><span></span><span></span>';
				
				indicatorWrapper.appendChild(indicator);
				chatWindow.appendChild(indicatorWrapper);
				chatWindow.scrollTop = chatWindow.scrollHeight;
			}
			
			function removeTypingIndicator() {
				const indicator = document.getElementById('typing-indicator');
				if (indicator) indicator.remove();
			}
			
			function autoResizeTextarea() {
				this.style.height = 'auto';
				this.style.height = `${this.scrollHeight}px`;
			}
			
			function setChatInputDisabled(isDisabled) {
				sendButton.disabled = isDisabled;
				messageInput.disabled = isDisabled;
				if (!isDisabled) messageInput.focus();
			}
			
			loginButton.addEventListener('click', () => {
				loginContainer.style.display = 'none';
				chatContainer.style.display = 'flex';
				startNewChat();
			});
			
			newChatButton.addEventListener('click', startNewChat);
			
			logoutButton.addEventListener('click', () => {
				chatContainer.style.display = 'none';
				loginContainer.style.display = 'flex';
				apiKey = '';
				chatWindow.innerHTML = '';
			});
			
			sendButton.addEventListener('click', sendMessage);
			uploadButton.addEventListener('click', () => fileInput.click());
			fileInput.addEventListener('change', handleFileSelect);
			messageInput.addEventListener('input', autoResizeTextarea);
			messageInput.addEventListener('keydown', (e) => {
				if (e.key === 'Enter' && !e.shiftKey) {
					e.preventDefault();
					sendMessage();
				}
			});
			
			// PERBAIKAN: Listener untuk masalah keyboard di iOS
			messageInput.addEventListener('blur', () => {
				// Memberi jeda singkat agar peramban sempat memproses
				setTimeout(() => {
					window.scrollTo(0, 0);
				}, 100);
			});
			
		});
	</script>
	
	<script>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', () => {
				navigator.serviceWorker.register('./sw.js').then(registration => {
					console.log('Pendaftaran ServiceWorker berhasil dengan cakupan: ', registration.scope);
				}, err => {
					console.log('Pendaftaran ServiceWorker gagal: ', err);
				});
			});
		}
	</script>
	
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
	<script>
		pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
	</script>
</body>

</html>
